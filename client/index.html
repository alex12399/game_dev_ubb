<div id='signDiv'>
    Username: <input id='signDiv-username' type='text'></input><br>
    Password: <input id='signDiv-password' type='password'></input>
    <button id='signDiv-signIn'>Sign In</button>
    <button id='signDiv-signUp'>Sign Up</button>
</div>

<div id='gameDiv' style='display:none'>
    <canvas id='ctx', width='500', height='500' style='border:1px solid #000000'></canvas>

    <div id='chat-text' style='width:500px; height:100px; overflow-y:scroll'>
        <div>Hello!</div>
    </div>
    <form id='chat-form'>
        <input id='chat-input' type='text' style='width:500px'></input>
    </form>
</div>

<script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js'></script>
<script>
    const socket = io();

    //sign
    const signDiv = document.getElementById('signDiv');
    const gameDiv = document.getElementById('gameDiv');
    const signDivUsername = document.getElementById('signDiv-username');
    const signDivPassword = document.getElementById('signDiv-password');
    const signDivSignIn = document.getElementById('signDiv-signIn');
    const signDivSignUp = document.getElementById('signDiv-signUp');

    signDivSignIn.onclick = async () => {
        socket.emit('signIn', {username: signDivUsername.value, password: signDivPassword.value});
    }

    signDivSignUp.onclick = async () => {
        socket.emit('signUp', {username: signDivUsername.value, password: signDivPassword.value});
    }

    socket.on('signInResponse', async (data) => {
        if (data.success) {
            signDiv.style.display = 'none';
            gameDiv.style.display = 'inline-block';
        } else {
            alert('Sign in unsuccessful');
        }
    })

    socket.on('signUpResponse', async (data) => {
        if (data.success) alert('Sign up successful');
        else alert('Sign up unsuccessful');
    })

    //game
    const chatText = document.getElementById('chat-text');
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    const ctx = document.getElementById('ctx').getContext('2d');
    ctx.font='30px Arial';

    socket.on('newPositions', async (data) => {
        ctx.clearRect(0, 0, 500, 500);
        data.players.forEach(async (player) => {
            ctx.fillText(player.number, player.x, player.y);  
        });
        data.bullets.forEach(async (bullet) => {
            ctx.fillRect(bullet.x - 5, bullet.y - 5, 10, 10);  
        });
    });

    socket.on('addToChat', async (data) => {
        chatText.innerHTML += '<div>' + data + '</div>';
    });

    chatForm.onsubmit = async (e) => {
        e.preventDefault();
        socket.emit('sendMsgToServer', chatInput.value);
        chatInput.value = '';
    }

    document.onkeydown = async (event) => {
        //d
        if(event.keyCode === 68) socket.emit('keyPress', {inputId: 'right', state: true});
        //s
        if(event.keyCode === 83) socket.emit('keyPress', {inputId: 'down', state: true});
        //a
        if(event.keyCode === 65) socket.emit('keyPress', {inputId: 'left', state: true});
        //w
        if(event.keyCode === 87) socket.emit('keyPress', {inputId: 'up', state: true});        
    };

    document.onkeyup = async (event) => {
        //d
        if(event.keyCode === 68) socket.emit('keyPress', {inputId: 'right', state: false});
        //s
        if(event.keyCode === 83) socket.emit('keyPress', {inputId: 'down', state: false});
        //a
        if(event.keyCode === 65) socket.emit('keyPress', {inputId: 'left', state: false});
        //w
        if(event.keyCode === 87) socket.emit('keyPress', {inputId: 'up', state: false});        
    };

    document.onmousedown = async (event) => {
        socket.emit('keyPress', {inputId: 'attack', state: true});
    }

    document.onmouseup = async (event) => {
        socket.emit('keyPress', {inputId: 'attack', state: false});
    }

    document.onmousemove = async (event) => {
        const x = -250 + event.clientX - 8;
        const y = -250 + event.clientY - 8;
        const angle = Math.atan2(y, x) / Math.PI * 180;
        socket.emit('keyPress', {inputId: 'mouseAngle', state: angle});
    }
</script>